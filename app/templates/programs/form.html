{% extends "base.html" %}
{% block content %}
<h3>{{ 'Edit' if program else 'New' }} Program</h3>
<form method="post">
  <div class="mb-3">
    <label class="form-label">Name</label>
    <input class="form-control" type="text" name="name" value="{{ program.name if program else '' }}" required>
  </div>
  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">Campaign</label>
      <select class="form-select" id="campaign_id" name="campaign_id" required>
        <option value="">Selectâ€¦</option>
        {% for c in campaigns %}
        <option value="{{ c.id }}" {% if program and c.id == program.campaign_id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <div class="form-text">Target Lists below will filter by this campaign's pharma/brands.</div>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label" style="margin-right: 5px;">Target List</label>
      <input class="form-check-input" type="checkbox" id="show_all_tls">
      <label class="form-check-label" for="show_all_tls">Show all</label>
      <div class="d-flex gap-2">
        <select class="form-select" id="target_list_id" name="target_list_id">
          <option value="">(none)</option>
          {% if target_lists is defined %}
            {% for tl in target_lists %}
              <option value="{{ tl.id }}" {% if program and tl.id == program.target_list_id %}selected{% endif %}>{{ tl.label }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-3 mb-3">
      <label class="form-label">Start</label>
      <input class="form-control" type="date" name="start_date" value="{{ program.start_date if program and program.start_date else '' }}">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">End</label>
      <input class="form-control" type="date" name="end_date" value="{{ program.end_date if program and program.end_date else '' }}">
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label" for="platform">Platform</label>
      <select class="form-select" id="platform" name="platform">
        {% set platforms = ['app', 'cmd', 'dx'] %}
        {% for opt in platforms %}
          <option value="{{ opt }}" {% if program.platform == opt %}selected{% endif %}>
            {{ opt }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 mb-3">
      <label class="form-label">Asset ID</label>
      <input class="form-control" type="text" name="asset_id" value="{{ program.asset_id if program and program.asset_id else '' }}">
    </div>
  </div>
  <div class="row">
    <div class="col-md-4 mb-3"><label class="form-label">Program Type</label><input class="form-control" type="text" name="program_type" value="{{ program.program_type if program else '' }}"></div>
    <div class="col-md-4 mb-3"><label class="form-label">Content Type</label><input class="form-control" type="text" name="content_type" value="{{ program.content_type if program else '' }}"></div>
    <div class="col-md-4 mb-3"><label class="form-label">Audience Segment</label><input class="form-control" type="text" name="audience_segment" value="{{ program.audience_segment if program else '' }}"></div>
  </div>
  <div class="row">
    <div class="col-md-6 mb-3"><label class="form-label">Expected Reach</label><input class="form-control" type="number" name="expected_reach" value="{{ program.expected_reach if program else '' }}"></div>
    <div class="col-md-6 mb-3"><label class="form-label">Notes</label><input class="form-control" type="text" name="notes" value="{{ program.notes if program else '' }}"></div>
  </div>
  <button class="btn btn-primary">Save</button>
</form>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
(function() {
  async function loadTargetLists() {
    const selCampaign = document.getElementById('campaign_id');
    const selTL = document.getElementById('target_list_id');
    const showAll = document.getElementById('show_all_tls')?.checked;
    const currentTL = "{{ program.target_list_id if program else '' }}";

    if (!selTL) return;

    const params = new URLSearchParams();
    if (showAll) {
      params.set('all', '1');
    } else {
      // require a campaign for filtered results
      if (!selCampaign || !selCampaign.value) {
        selTL.innerHTML = '<option value="">(none)</option>';
        return;
      }
      params.set('campaign_id', selCampaign.value);
      if (currentTL) params.set('current_tl_id', currentTL);
    }

    const res = await fetch('/programs/api/target-lists?' + params.toString());
    if (!res.ok) {
      console.warn('TL fetch failed', res.status);
      return;
    }
    const data = await res.json();

    selTL.innerHTML = '<option value="">(none)</option>';
    for (const tl of data) {
      const opt = document.createElement('option');
      opt.value = tl.id;
      opt.textContent = tl.label;
      if (currentTL && String(tl.id) === String(currentTL)) opt.selected = true;
      selTL.appendChild(opt);
    }
  }

  function init() {
    const selCampaign = document.getElementById('campaign_id');
    const showAll = document.getElementById('show_all_tls');

    selCampaign && selCampaign.addEventListener('change', loadTargetLists);
    showAll && showAll.addEventListener('change', loadTargetLists);

    // initial load
    loadTargetLists();
  }

  window.addEventListener('DOMContentLoaded', init);
})();
</script>
{% endblock %}
