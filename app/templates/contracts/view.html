
{% extends "base.html" %}
{% block content %}
<h3 class="mb-1">Contract: {{ contract.name }}</h3>
<p class="text-muted mb-2">
  Pharma: <strong>{{ contract.pharma.name }}</strong> ·
  Brands: {{ contract.brands | map(attribute='name') | list | join(', ') }}
</p>

<!-- Full contract info -->
<div class="row g-3 mb-4">
  <div class="col-md-2"><div class="small text-muted">Contract #</div><div>{{ contract.contract_number or '—' }}</div></div>
  <div class="col-md-2"><div class="small text-muted">Status</div><div>{{ contract.status or '—' }}</div></div>
  <div class="col-md-2"><div class="small text-muted">Budget Total</div><div>{{ contract.budget_total if contract.budget_total is not none else '—' }}</div></div>
  <div class="col-md-2"><div class="small text-muted">Billing Terms</div><div>{{ contract.billing_terms or '—' }}</div></div>
  <div class="col-md-2"><div class="small text-muted">Signed</div><div>{{ contract.signed_date or '—' }}</div></div>
  <div class="col-md-2"><div class="small text-muted">Window</div><div>{{ contract.start_date or '—' }} → {{ contract.end_date or '—' }}</div></div>
  {% if contract.notes %}
  <div class="col-12"><div class="small text-muted">Notes</div><div class="border rounded p-2 bg-light">{{ contract.notes }}</div></div>
  {% endif %}
</div>

<!-- Campaigns accordion with improved table and inline placement edit via modal -->
<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="card-title mb-3">Campaigns, Programs & Placements</h5>

    {% if campaigns %}
      <div class="accordion" id="campaignsAcc">
        {% for c in campaigns %}
        {% set collapse_id = 'collapse-' ~ c.id %}
        {% set heading_id = 'heading-' ~ c.id %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="{{ heading_id }}">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}"
                    aria-expanded="false" aria-controls="{{ collapse_id }}">
              <div class="w-100 d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ c.name }}</strong>
                  {% if c.status %}<span class="badge bg-secondary ms-2">{{ c.status }}</span>{% endif %}
                  {% if c.start_date or c.end_date %}
                    <small class="text-muted ms-2">{{ c.start_date or '—' }} → {{ c.end_date or '—' }}</small>
                  {% endif %}
                </div>
                <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('campaigns.edit_campaign', campaign_id=c.id) }}" style="margin-right: 10px;">Edit</a>
              </div>
            </button>
          </h2>
          <div id="{{ collapse_id }}" class="accordion-collapse collapse" aria-labelledby="{{ heading_id }}" data-bs-parent="#campaignsAcc">
            <div class="accordion-body">
              {% set programs = programs_by_campaign.get(c.id, []) %}
              {% if programs %}
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="width:20%">Program</th>
                      <th style="width:20%">Target List</th>
                      <th style="width:42%">Placements</th>
                      <th style="width:10%">Status</th>
                      <th style="width:8%"></th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for p in programs %}
                    <tr>
                      <td>
                        <div class="fw-semibold">{{ p.name }}</div>
                        {% if p.start_date or p.end_date %}
                          <div class="small text-muted">{{ p.start_date or '—' }} → {{ p.end_date or '—' }}</div>
                        {% endif %}
                      </td>
                      <td>{{ p.target_list.label if p.target_list else '' }}</td>
                      <td>
                        {% if p.placements %}
                          <div class="d-flex flex-wrap gap-2">
                          {% for pl in p.placements %}
                            <span class="badge bg-info text-dark" data-bs-toggle="modal" data-bs-target="#editPlModal-{{ pl.id }}" style="cursor:pointer" title="Edit placement">
                              {{ pl.name }}
                              {% if pl.channel %}<span class="ms-1">· {{ pl.channel }}</span>{% endif %}
                              {% if pl.status %}<span class="ms-1">· {{ pl.status }}</span>{% endif %}
                            </span>

                            <!-- Edit Placement Modal -->
                            <div class="modal fade" id="editPlModal-{{ pl.id }}" tabindex="-1" aria-hidden="true">
                              <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                <div class="modal-content">
                                  <form method="post" action="{{ url_for('placements.edit_placement', placement_id=pl.id) }}">
                                    <div class="modal-header">
                                      <h5 class="modal-title">Edit Placement: {{ pl.name }}</h5>
                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                      <input type="hidden" name="next" value="{{ url_for('contracts.view_contract', contract_id=contract.id) }}">
                                      <div class="row g-3">
                                        <div class="col-md-6">
                                          <label class="form-label">Name</label>
                                          <input class="form-control" type="text" name="name" value="{{ pl.name }}" required>
                                        </div>
                                        <div class="col-md-6">
                                          <label class="form-label">Placement Code</label>
                                          <input class="form-control" type="text" name="placement_code" value="{{ pl.placement_code or '' }}">
                                        </div>
                                        <div class="col-md-6">
                                          <label class="form-label">Programs (multi-select)</label>
                                          {% set sel_ids = pl.programs | map(attribute='id') | list %}
                                          <select class="form-select" name="program_ids" multiple size="6" required>
                                            {% for p2 in all_programs %}
                                            <option value="{{ p2.id }}" {% if p2.id in sel_ids %}selected{% endif %}>{{ p2.name }} ({{ p2.campaign.name }})</option>
                                            {% endfor %}
                                          </select>
                                        </div>
                                        <div class="col-md-6">
                                          <label class="form-label">Channel</label>
                                          <input class="form-control" type="text" name="channel" value="{{ pl.channel or '' }}">
                                        </div>
                                        <div class="col-md-4">
                                          <label class="form-label">Status</label>
                                          <input class="form-control" type="text" name="status" value="{{ pl.status or '' }}">
                                        </div>
                                        <div class="col-md-4">
                                          <label class="form-label">Format</label>
                                          <input class="form-control" type="text" name="format" value="{{ pl.format or '' }}">
                                        </div>
                                        <div class="col-md-4">
                                          <label class="form-label">Ad Server</label>
                                          <input class="form-control" type="text" name="ad_server" value="{{ pl.ad_server or '' }}">
                                        </div>
                                        <div class="col-md-4">
                                          <label class="form-label">Frequency Cap</label>
                                          <input class="form-control" type="number" name="frequency_cap" value="{{ pl.frequency_cap or '' }}">
                                        </div>
                                        <div class="col-md-4">
                                          <label class="form-label">Impression Goal</label>
                                          <input class="form-control" type="number" name="impression_goal" value="{{ pl.impression_goal or '' }}">
                                        </div>
                                        <div class="col-md-4">
                                          <label class="form-label">Click Goal</label>
                                          <input class="form-control" type="number" name="click_goal" value="{{ pl.click_goal or '' }}">
                                        </div>
                                        <div class="col-md-6">
                                          <label class="form-label">Start</label>
                                          <input class="form-control" type="date" name="start_date" value="{{ pl.start_date.isoformat() if pl.start_date else '' }}">
                                        </div>
                                        <div class="col-md-6">
                                          <label class="form-label">End</label>
                                          <input class="form-control" type="date" name="end_date" value="{{ pl.end_date.isoformat() if pl.end_date else '' }}">
                                        </div>
                                      </div>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                      <button class="btn btn-primary">Save Changes</button>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                            <!-- /Modal -->

                          {% endfor %}
                          </div>
                        {% else %}
                          <span class="text-muted">No placements</span>
                        {% endif %}
                      </td>
                      <td>{{ p.status or '' }}</td>
                      <td class="text-end">
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editProgModal-{{ p.id }}">
                          Edit
                        </button>
                      </td>
                    </tr>
                    {# --- Edit Program Modal (filtered TLs) --- #}
                    {% set modal_id = 'editProgModal-' ~ p.id %}
                    <div class="modal fade" id="{{ modal_id }}" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                          <form method="post" action="{{ url_for('programs.edit_program', program_id=p.id) }}">
                            <div class="modal-header">
                              <h5 class="modal-title">Edit Program: {{ p.name }}</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <input type="hidden" name="next" value="{{ url_for('contracts.view_contract', contract_id=contract.id) }}">
                              {% include "programs/edit.html" with context %}
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                              <button class="btn btn-primary">Save Changes</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                    {# --- /Edit Program Modal --- #}
                  {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <div class="text-muted">No programs yet.</div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info mb-0">No campaigns yet. Use the tabs above to add your first campaign.</div>
    {% endif %}
  </div>
</div>

<!-- Tabbed full forms -->
<div class="card shadow-sm" style="margin-top: 15px;">
  <div class="card-body">
    <h5 class="card-title mb-3">Add Items</h5>
    <ul class="nav nav-tabs mb-3" id="contractFormsTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-campaign" data-bs-toggle="tab" data-bs-target="#pane-campaign" type="button" role="tab" aria-controls="pane-campaign" aria-selected="true">Add Campaign</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-program" data-bs-toggle="tab" data-bs-target="#pane-program" type="button" role="tab" aria-controls="pane-program" aria-selected="false">Add Program</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-placement" data-bs-toggle="tab" data-bs-target="#pane-placement" type="button" role="tab" aria-controls="pane-placement" aria-selected="false">Add Placement</button>
      </li>
    </ul>
    <div class="tab-content mb-4" id="contractFormsTabContent">
      <!-- Campaign full form -->
      <div class="tab-pane fade show active" id="pane-campaign" role="tabpanel" aria-labelledby="tab-campaign" tabindex="0">
        <form class="card card-body border-0 shadow-sm" method="post" action="{{ url_for('contracts.contract_create_campaign', contract_id=contract.id) }}">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input class="form-control" type="text" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Campaign Code</label>
              <input class="form-control" type="text" name="campaign_code" placeholder="optional">
            </div>
            <div class="col-md-4">
              <label class="form-label">Start</label>
              <input class="form-control" type="date" name="start_date">
            </div>
            <div class="col-md-4">
              <label class="form-label">End</label>
              <input class="form-control" type="date" name="end_date">
            </div>
            <div class="col-md-4">
              <label class="form-label">Launch</label>
              <input class="form-control" type="date" name="launch_date">
            </div>
            <div class="col-md-4">
              <label class="form-label">Status</label>
              <input class="form-control" type="text" name="status" placeholder="planned, in-flight, paused, complete">
            </div>
            <div class="col-md-4">
              <label class="form-label">Objective</label>
              <input class="form-control" type="text" name="objective" placeholder="awareness, engagement, ...">
            </div>
            <div class="col-md-4">
              <label class="form-label">KPI Goals (JSON)</label>
              <input class="form-control" type="text" name="kpi_goals" placeholder='{"opens":10000,"clicks":2000}'>
            </div>
            <div class="col-12">
              <label class="form-label">Channel Mix (JSON)</label>
              <input class="form-control" type="text" name="channel_mix" placeholder='{"email":true,"banner":true}'>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="3"></textarea>
            </div>
          </div>
          <div class="mt-3">
            <button class="btn btn-primary">Create Campaign</button>
          </div>
        </form>
      </div>

      <!-- Program full form -->
      <div class="tab-pane fade" id="pane-program" role="tabpanel" aria-labelledby="tab-program" tabindex="0">
        <form class="card card-body border-0 shadow-sm" method="post" action="{{ url_for('contracts.contract_create_program', contract_id=contract.id) }}">
          {% from "macros/programs.html" import create_program %}
          <form method="post">
            {{ create_program(
                campaigns=campaigns,
                target_lists=target_lists,
                program=program
              ) }}
          </form>
        </form>
      </div>

      <!-- Placement full form -->
      <div class="tab-pane fade" id="pane-placement" role="tabpanel" aria-labelledby="tab-placement" tabindex="0">
        <form class="card card-body border-0 shadow-sm" method="post" action="{{ url_for('contracts.contract_create_placement', contract_id=contract.id) }}">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input class="form-control" type="text" name="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Placement Code</label>
              <input class="form-control" type="text" name="placement_code" placeholder="optional">
            </div>
            <div class="col-md-6">
              <label class="form-label">Programs (multi-select)</label>
              <select class="form-select" name="program_ids" multiple size="6" required>
                {% for p in all_programs %}
                <option value="{{ p.id }}">{{ p.name }} ({{ p.campaign.name }})</option>
                {% endfor %}
              </select>
              <div class="form-text">Hold Ctrl/⌘ to select multiple.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Channel</label>
              <input class="form-control" type="text" name="channel" placeholder="email, web, app">
            </div>
            <div class="col-md-4">
              <label class="form-label">Status</label>
              <input class="form-control" type="text" name="status" placeholder="planned, live, paused, completed">
            </div>
            <div class="col-md-4">
              <label class="form-label">Format</label>
              <input class="form-control" type="text" name="format" placeholder="HTML banner, native, ...">
            </div>
            <div class="col-md-4">
              <label class="form-label">Ad Server</label>
              <input class="form-control" type="text" name="ad_server" placeholder="AdButler, Veeva, ...">
            </div>
            <div class="col-md-4">
              <label class="form-label">Frequency Cap</label>
              <input class="form-control" type="number" name="frequency_cap">
            </div>
            <div class="col-md-4">
              <label class="form-label">Impression Goal</label>
              <input class="form-control" type="number" name="impression_goal">
            </div>
            <div class="col-md-4">
              <label class="form-label">Click Goal</label>
              <input class="form-control" type="number" name="click_goal">
            </div>
            <div class="col-md-6">
              <label class="form-label">Start</label>
              <input class="form-control" type="date" name="start_date">
            </div>
            <div class="col-md-6">
              <label class="form-label">End</label>
              <input class="form-control" type="date" name="end_date">
            </div>
          </div>
          <div class="mt-3">
            <button class="btn btn-primary">Create Placement</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}