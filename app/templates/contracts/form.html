{% extends "base.html" %}
{% block content %}
<h3>{{ 'Edit' if contract else 'New' }} Contract</h3>
<form method="post">
  <div class="mb-3">
    <label class="form-label">Contract Name</label>
    <input class="form-control" type="text" name="name" value="{{ contract.name if contract else '' }}" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Pharma</label>
    <select class="form-select" id="pharma_id" name="pharma_id" required>
      <option value="">Select…</option>
      {% for p in pharmas %}
      <option value="{{ p.id }}" {% if contract and p.id == contract.pharma_id %}selected{% endif %}>{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Brands</label>
    <select class="form-select" id="brand_ids" name="brand_ids" multiple size="6"></select>
    <div class="form-text">Hold Ctrl/⌘ to select multiple.</div>
  </div>
  <button class="btn btn-primary">Save</button>
</form>

<script>
async function loadBrands(pharmaId, selectedIds) {
  const brandSelect = document.getElementById('brand_ids');
  brandSelect.innerHTML = '';
  if (!pharmaId) return;
  const res = await fetch(`/contracts/api/brands/${pharmaId}`);
  if (!res.ok) return;
  const data = await res.json();
  data.sort((a,b)=> a.name.localeCompare(b.name));
  data.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b.id;
    opt.textContent = b.name;
    if (selectedIds && selectedIds.includes(b.id)) opt.selected = true;
    brandSelect.appendChild(opt);
  });
}

const pharmaSelect = document.getElementById('pharma_id');
pharmaSelect.addEventListener('change', () => loadBrands(pharmaSelect.value, []));

// On edit page, pre-select existing brands
{% if contract %}
  const preset = {{ (brands_selected or set())|list|tojson }};
  loadBrands({{ contract.pharma_id }}, preset);
{% endif %}
</script>
{% endblock %}
