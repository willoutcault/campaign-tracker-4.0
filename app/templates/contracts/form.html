{% extends "base.html" %}
{% block content %}
<h3>{{ 'Edit' if contract else 'New' }} Contract</h3>
<form method="post">
  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">Contract Name</label>
      <input class="form-control" type="text" name="name" value="{{ contract.name if contract else '' }}" required>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label">Contract #</label>
      <input class="form-control" type="text" name="contract_number" value="{{ contract.contract_number if contract else '' }}">
    </div>
  </div>
  <div class="mb-3">
    <label class="form-label">Pharma</label>
    <select class="form-select" id="pharma_id" name="pharma_id" required>
      <option value="">Selectâ€¦</option>
      {% for p in pharmas %}
      <option value="{{ p.id }}" {% if contract and p.id == contract.pharma_id %}selected{% endif %}>{{ p.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="row">
    <div class="col-md-4 mb-3">
      <label class="form-label">Start</label>
      <input class="form-control" type="date" name="start_date" value="{{ contract.start_date if contract and contract.start_date else '' }}">
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label">End</label>
      <input class="form-control" type="date" name="end_date" value="{{ contract.end_date if contract and contract.end_date else '' }}">
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label">Signed</label>
      <input class="form-control" type="date" name="signed_date" value="{{ contract.signed_date if contract and contract.signed_date else '' }}">
    </div>
  </div>
  <div class="row">
    <div class="col-md-4 mb-3">
      <label class="form-label">Budget Total</label>
      <input class="form-control" type="number" step="0.01" name="budget_total" value="{{ contract.budget_total if contract else '' }}">
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label">Billing Terms</label>
      <input class="form-control" type="text" name="billing_terms" value="{{ contract.billing_terms if contract else '' }}" placeholder="upfront, quarterly, monthly">
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label">Status</label>
      <input class="form-control" type="text" name="status" value="{{ contract.status if contract else '' }}" placeholder="draft, active, completed, cancelled">
    </div>
  </div>
  <div class="mb-3">
    <label class="form-label">Notes</label>
    <textarea class="form-control" name="notes" rows="3">{{ contract.notes if contract else '' }}</textarea>
  </div>
  <div class="mb-3">
    <label class="form-label">Brands</label>
    <select class="form-select" id="brand_ids" name="brand_ids" multiple size="6"></select>
  </div>
  <button class="btn btn-primary">Save</button>
</form>

<script>
async function loadBrands(pharmaId, selectedIds) {
  const brandSelect = document.getElementById('brand_ids');
  brandSelect.innerHTML = '';
  if (!pharmaId) return;
  const res = await fetch(`/contracts/api/brands/${pharmaId}`);
  if (!res.ok) return;
  const data = await res.json();
  data.sort((a,b)=> a.name.localeCompare(b.name));
  data.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b.id;
    opt.textContent = b.name;
    if (selectedIds && selectedIds.includes(b.id)) opt.selected = true;
    brandSelect.appendChild(opt);
  });
}
const pharmaSelect = document.getElementById('pharma_id');
pharmaSelect?.addEventListener('change', () => loadBrands(pharmaSelect.value, []));
{% if contract %}
  const preset = {{ (brands_selected or set())|list|tojson }};
  loadBrands({{ contract.pharma_id }}, preset);
{% endif %}
</script>
{% endblock %}